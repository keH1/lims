server {
    listen 80;
    listen [::]:80;
    server_name bitrix;

    root /var/www/bitrix;
    index index.php index.html bitrixsetup.php restore.php;
    charset utf-8;

    access_log /var/log/nginx/bitrix-access.log combined buffer=16k flush=5m;
    error_log /var/log/nginx/bitrix-error.log warn;

    # Безопасность
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";

    # Удаление двойных слэшей
    merge_slashes on;

    # Основной location
    location / {
        try_files $uri $uri/ @bitrix;
    }

    # Bitrix URL rewriting
    location @bitrix {
        include fastcgi_params;
        fastcgi_pass php-upstream;
        fastcgi_param SERVER_NAME $host;
        fastcgi_param SCRIPT_FILENAME $document_root/bitrix/urlrewrite.php;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    # Специфический location для /ulab/
    location /ulab/ {
        try_files $uri /ulab/index.php?$query_string;
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass php-upstream;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_script_name;
            fastcgi_buffers 16 16k;
            fastcgi_buffer_size 32k;
        }
    }

    # Обработка restore.php
    location = /restore.php {
        include fastcgi_params;
        fastcgi_pass php-upstream;
        fastcgi_index index.php;
        fastcgi_send_timeout 3600s;
        fastcgi_read_timeout 3600s;
        fastcgi_param SERVER_NAME $host;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        client_max_body_size 32m;
        client_body_buffer_size 128k;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    # Статические файлы
    location ~* \.(jpg|jpeg|gif|png|svg|js|css|mp3|ogg|mpe?g|avi|zip|gz|bz2?|rar|eot|otf|ttf|woff|woff2)$ {
        access_log off;
        log_not_found off;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
        try_files $uri =404;
    }

    # Favicon и robots.txt
    location ~ ^/(favicon\.ico|robots\.txt)$ {
        access_log off;
        log_not_found off;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Защита чувствительных путей
    location ~ (/\.ht|/\.git|/\.gitignore|\.settings\.php|/composer\.json|/composer\.lock|/bitrix/backup|/bitrix/updates|/bitrix/modules|/bitrix/php_interface|/bitrix/stack_cache|/bitrix/managed_cache|/bitrix/html_pages/\.|/upload/1c_exchange|/local/modules|/local/php_interface|/logs/) {
        deny all;
        return 403;
    }

    # Внутренний location
    location ^~ /upload/support/not_image {
        internal;
    }

    # Ограничение для /upload/
    location ~ /upload/ {
        client_max_body_size 32m;
        client_body_buffer_size 128k;
    }

    # Запрет доступа к кэшу Bitrix
    location ~* ^/bitrix/cache {
        deny all;
        return 403;
    }

    # Обработка PHP
    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass php-upstream;
        fastcgi_index index.php;
        fastcgi_send_timeout 3600s;
        fastcgi_read_timeout 3600s;
        fastcgi_param SERVER_NAME $host;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    # Страницы ошибок
    error_page 404 /404.html;
    location = /404.html {
        internal;
    }

    error_page 500 /500.html;
    location = /500.html {
        internal;
    }
}